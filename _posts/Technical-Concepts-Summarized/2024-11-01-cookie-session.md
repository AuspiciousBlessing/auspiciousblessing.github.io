---
layout: post
title: Cookie & Session
description: Cookie & Session
date: 2024-11-01 11:00:00 +0900
categories: [Technical Concepts Summarized]
tags: [session, cookie]
pin: false
math: false
mermaid: false
image:
  path: commons/cookie-session/title.png
  alt: HTTP(Hypertext Transfer Protocol)
---
<!-- categories: [Technical Concepts Summarized, Technical Labs, Technical Terms, Useful Apps To Help With Technology] -->

## Overview
쿠키와 세션의 복잡성을 살펴보기 전에 웹을 지배하는 기본 프로토콜인 HTTP(HyperText Transfer Protocol)를 이해하는 것이 중요합니다. 기본적으로 HTTP는 텍스트 및 이미지에서 비디오 등에 이르기까지 웹 사이트를 구성하는 수많은 파일과 데이터를 전송하기 위한 일련의 규칙입니다. URI(Uniform Resource Identifier)로 식별할 수 있는 리소스의 기본 원칙과 간단하지만 강력한 클라이언트 서버 통신 모델을 기반으로 합니다.

그러나 HTTP는 stateless(상태 비저장)으로 설계되었습니다. 즉, 브라우저에서 서버로의 각 요청은 이전 요청에 대한 메모리 없이 완전히 새로운 상호 작용으로 처리됩니다. 이러한 단순성에는 장점이 있지만, 서버가 한 트랜잭션에서 다음 트랜잭션으로 우리가 누구인지 어떻게 기억하는가에 대한 문제가 제기됩니다.

이것이 바로 쿠키와 세션이 필요한 곳입니다.

## What is cookies?
쿠키는 웹 서버가 웹 브라우저에 사용자의 장치에 저장하도록 요청하는 작은 데이터 파일입니다. 브라우저는 서버에서 페이지를 가져올 때마다 이러한 쿠키를 서버로 다시 보냅니다. 이 메커니즘을 통해 쿠키를 통해 서버는 사용자 정보를 알 수 있으므로 사용자 로그인 유지, 사이트 기본 설정 저장 및 사용자 검색 패턴 추적과 같은 다양한 작업을 지원할 수 있습니다.

### The structure of a cookie
```
| Domain     | Flag | Path | Name        | Value        | Secure | Date       |
| ---------- | ---- | ---- | ----------- | ------------ | ------ | ---------- |
| origin.com | True | /    | Cookie_Name | Cookie_Value | True   | 11/01/2024 |
```
- name: 쿠키의 키 또는 식별자입니다. 쿠키가 참조되는 이름입니다.
- value: 쿠키 내에 저장된 데이터입니다. 이것은 서버가 사용자에 대해 기억하고자 하는 정보입니다.
- expires: 쿠키가 만료되는 날짜 및 시간입니다. 그 후에는 쿠키가 자동으로 제거됩니다.
- path: 도메인 내 쿠키의 범위(쿠키를 보내야 하는 URL)를 정의합니다.
- domain: 쿠키가 속한 도메인을 지정합니다. 쿠키의 범위를 지정된 도메인과 해당 하위 도메인으로 설정합니다.
- secure: 쿠키가 HTTPS와 같은 보안 프로토콜을 통해서만 전송되어야 함을 나타내는 플래그입니다.
- HttpOnly: 보호된 쿠키에 액세스하는 클라이언트 쪽 스크립트의 위험을 완화하는 데 도움이 되는 플래그입니다.

### Security Concerns with Cookies
쿠키는 웹 브라우징의 기본 구성 요소이지만 쿠키 사용에는 여러 가지 보안 관련 사항이 있습니다. 쿠키와 관련된 주요 보안 문제 중 일부는 다음과 같습니다.

- **Sensitive Data Exposure**: 쿠키에는 세션 토큰이나 개인 정보와 같은 민감한 데이터가 포함될 수 있습니다. 쿠키가 적절하게 보호되지 않으면 이러한 데이터가 허가되지 않은 사용자에게 노출되어 개인정보 침해나 신원 도용으로 이어질 수 있습니다.

- **Cross-Site Scripting (XSS)**: 쿠키에 HttpOnly 속성이 설정되어 있지 않으면 JavaScript로 접근이 가능합니다. 즉, 공격자가 악성 스크립트를 웹 페이지에 삽입할 수 있는 XSS 취약점이 있을 경우, 쿠키 데이터(세션 쿠키 포함)를 읽고 탈취할 수 있습니다.

- **Cross-Site Request Forgery (CSRF)**: 공격자는 쿠키를 이용해 사용자의 동의 없이 로그인된 사용자를 대신하여 행동을 수행할 수 있습니다. 만약 공격자가 사용자의 브라우저를 속여서 사용자가 인증된 사이트에 요청을 보내게 한다면, 해당 사이트에 첨부된 쿠키가 자동으로 포함되어 권한 없는 행동이 발생할 수 있습니다.

- **Session Hijacking**: 공격자가 사용자의 쿠키(특히 세션 쿠키)를 가로채면 웹사이트에서 사용자를 가장할 수 있습니다. Secure 플래그는 쿠키가 암호화된 HTTPS 연결을 통해서만 전송되도록 하여 이러한 위험을 완화하는 데 도움이 되지만, 사용자가 비보안 연결을 사용하도록 속으면 완벽한 보호를 제공하지는 않습니다.
  
- **Cookie Tossing**: 공격자가 서브도메인에서 쿠키를 설정하여 메인 도메인의 쿠키와 충돌하게 하는 방법입니다. 이로 인해 합법적인 쿠키가 악성 쿠키로 덮어씌워져 사용자 세션을 탈취하거나 다른 공격을 수행할 수 있습니다.

- **Third-Party Cookies**: 이러한 쿠키는 사용자가 방문 중인 도메인 외의 도메인에서 설정되며, 여러 사이트에 걸쳐 사용자의 활동을 추적하여 상세한 브라우징 습관 프로필을 생성할 수 있습니다. 이는 개인정보 보호 문제를 유발하며, 이를 해결하기 위한 새로운 규제 및 브라우저 기능이 개발되고 있습니다.

## What is sessions?
세션은 마치 사무실 건물에서 방문자에게 주는 임시 신분증과 같습니다. 처음 건물에 들어가면 접수원은 당신이 누구인지, 왜 왔는지 모릅니다. 그래서 번호가 적힌 배지를 줍니다. 이 번호는 당신에 대한 개인적인 정보를 드러내지 않으며, 단지 사무실 직원이 당신의 방문을 추적하고 방문 중에 필요한 도움을 제공하기 위한 도구일 뿐입니다.

다른 부서를 방문할 때마다 이 배지를 보여주면 직원들은 번호를 통해 관련 메모를 확인할 수 있습니다. 예를 들어, 특정 구역에 들어갈 수 있다거나 특별한 도움을 요청했다는 내용이 있을 수 있습니다. 배지를 가지고 있는 동안 당신의 활동이 기억됩니다.

건물을 떠나게 되면 배지를 반납합니다. 이제 사무실은 당신의 방문을 추적할 필요가 없어졌으므로 그 번호에 연결된 정보는 폐기되거나 다음 방문자를 위해 준비됩니다. 만약 다른 날 다시 방문하게 된다면 새로운 번호가 적힌 새로운 배지를 받게 됩니다.

웹 세계에서 세션도 이와 유사하게 작동합니다.

1. **처음 시작**: 웹사이트에 처음 방문하면 서버는 고유한 세션 ID를 부여하고, 이 ID는 쿠키에 저장되어 브라우저에 남습니다.

2. **방문 중**: 링크를 클릭하거나 양식을 제출하는 등의 요청을 보낼 때마다 브라우저는 세션 쿠키를 다시 서버에 보내 서버가 당신을 기억하게 합니다. 서버는 이 ID를 사용하여 서버의 파일이나 메모리 혹은 데이터베이스에서 세션 데이터를 가져옵니다.

3. **정보 저장**: 이 세션 데이터는 쇼핑 카트에 추가한 상품부터 로그인 상태까지 무엇이든 저장할 수 있습니다.

4. **세션 종료**: 로그아웃하거나 브라우저를 닫거나 일정 시간이 지나면 세션이 종료됩니다. ID 배지를 반납하는 것처럼 서버의 고유 방문 데이터도 삭제될 수 있습니다.

세션의 장점은 방문자를 영구히 기억할 필요 없이, 개인화된 연속적인 경험을 제공할 수 있다는 점입니다. 서버는 당신을 잠시 인식하고, 방문 중에 의미 있게 상호작용할 수 있는 방법을 제공하는 것입니다.

## Security guidelines
쿠키와 세션을 안전하게 관리하는 것은 사용자 데이터의 무결성과 기밀성을 유지하고, 세션 하이재킹 및 크로스 사이트 스크립팅(XSS)과 같은 일반적인 공격에 애플리케이션이 취약하지 않도록 하기 위해 중요합니다.

1. **HTTPS와 TLS 사용**
- 항상 HTTPS를 통해 사이트를 제공하고 TLS(전송 계층 보안)를 사용하여 전송 중인 쿠키 데이터를 보호하세요. 이를 통해 중간자(MITM) 공격을 통한 세션 하이재킹을 방지할 수 있습니다.
- 쿠키가 HTTPS 연결을 통해서만 전송되도록 Secure 쿠키 속성을 사용하세요.

2. **쿠키 속성을 적절히 설정하기**
- HttpOnly: JavaScript를 통해 쿠키 데이터에 접근하는 것을 방지하기 위해 이 속성을 설정하세요. 이를 통해 클라이언트 측 스크립트가 보호된 쿠키 데이터에 접근하는 위험을 줄이고 잠재적인 XSS 취약점의 영향을 완화할 수 있습니다.
- SameSite: 이 속성은 크로스 사이트 요청과 함께 쿠키가 전송되는지 여부를 제어합니다. CSRF(크로스 사이트 요청 위조) 공격을 방지하기 위해 SameSite=Strict 또는 SameSite=Lax로 설정하세요.
- Domain: 쿠키가 유효한 도메인을 정의하고, 애플리케이션의 도메인으로 이를 제한하여 쿠키 범위를 제어하세요.
- Path: Path 속성을 제한하여 쿠키가 전송되는 위치를 제한하세요.

3. **세션 내 민감한 데이터 최소화**
- 세션에 비밀번호나 개인 정보와 같은 민감한 데이터를 직접 저장하지 않도록 하세요. 꼭 필요한 경우 데이터를 암호화하세요.
- 세션 ID를 사용하여 서버 측에서 안전하게 저장된 데이터를 참조하세요.

4. **정기적인 세션 만료 구현**
- 세션에 합리적인 시간 초과를 설정하고, 세션을 적극적으로 만료시켜 오래된 세션의 무단 사용 위험을 줄이세요.
- 사용자와의 상호작용이 있을 때마다 세션 타이머가 재설정되는 슬라이딩 세션 만료를 구현하세요.
- 로그아웃할 때는 서버 측에서 세션을 삭제하고, 클라이언트 측에서 세션 쿠키를 지우세요.

5. **세션 ID 재생성**
- 권한 수준 변경(예: 로그인) 후 세션 ID를 변경하세요. 이를 통해 공격자가 사용자의 로그인 전에 세션 ID를 고정시키는 세션 고정화 공격을 방지할 수 있습니다.

6. **세션 쿠키 조작 방지**
- 클라이언트 또는 공격자에 의한 조작을 탐지하기 위해 서버 측 비밀 키로 세션 쿠키에 서명하세요.

7. **CSRF 토큰 사용**
- SameSite 쿠키 속성을 설정하는 것 외에도, CSRF 공격으로부터 보호하기 위해 CSRF 토큰을 사용하고, 민감한 작업에는 POST 요청을 요구하세요.

8. **콘텐츠 보안 정책 (CSP)**
- CSP를 사용하여 브라우저에서 로드되고 실행될 수 있는 콘텐츠의 소스를 제한하여 XSS 공격을 완화하세요.

9. **적절한 캐시 제어 헤더 설정**
- 민감한 데이터를 포함한 응답에는 Cache-Control: no-store를 사용하여 브라우저가 응답을 캐시하지 않도록 지시하고, 클라이언트 측에 민감한 데이터가 저장되지 않도록 하세요.

10.  **세션 활동 모니터링 및 로그 기록**
- 세션 생성, 무효화 및 사용을 추적하여 세션이 손상되었을 가능성을 나타낼 수 있는 비정상적인 활동을 모니터링하세요.
